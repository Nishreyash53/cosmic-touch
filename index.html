<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Cosmic Zen: Milky Way Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        #container { width: 100vw; height: 100vh; }
        
        #video-container { 
            position: absolute; bottom: 20px; right: 20px; width: 240px; height: 180px; 
            border-radius: 12px; overflow: hidden; border: 2px solid #00ffcc; 
            transform: scaleX(-1); background: #000; z-index: 20;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        #output_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .ui-overlay { 
            position: absolute; top: 20px; width: 100%; color: #00ffcc; 
            text-align: center; pointer-events: none; text-transform: uppercase; letter-spacing: 3px;
        }
        #loading {
            position: fixed; inset: 0; background: #000; color: #00ffcc;
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="loading">INITIALIZING COSMIC DYNAMICS...</div>
<div class="ui-overlay">
    <h2 id="gesture-status">System Idle</h2>
    <p id="sub-status" style="font-size: 10px;">Show hand to assemble the cosmos</p>
</div>

<div id="video-container">
    <video id="webcam" autoplay playsinline></video>
    <canvas id="output_canvas"></canvas>
</div>
<div id="container"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.9/dist/tweakpane.min.js"></script>

<script type="module">
    import * as THREE from 'three';

    const params = {
        template: 'MilkyWay',
        color: '#ffffff',
        size: 0.04,
        count: 75000, 
        tension: 12.0, 
        scatterAmount: 15.0,
        regainSpeed: 0.08, 
        rotationSmoothing: 0.1
    };

    let scene, camera, renderer, particles, material, geometry, handLandmarker;
    const video = document.getElementById('webcam');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const status = document.getElementById('gesture-status');
    const subStatus = document.getElementById('sub-status');

    async function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 12;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);

        const pane = new Tweakpane.Pane({title: 'COSMIC CONTROLS'});
        pane.addInput(params, 'template', { 
            options: { 
                MilkyWay: 'MilkyWay',
                Saturn: 'Saturn', 
                Hearts: 'Hearts', 
                Galaxy: 'Galaxy' 
            } 
        }).on('change', updateTemplate);
        pane.addInput(params, 'color');
        pane.addInput(params, 'size', { min: 0.01, max: 0.15 });

        createParticles();
        await setupAI();
        document.getElementById('loading').style.display = 'none';
        animate();
    }

    function createParticles() {
        if (particles) scene.remove(particles);
        geometry = new THREE.BufferGeometry();
        const pos = new Float32Array(params.count * 3);
        geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));

        material = new THREE.ShaderMaterial({
            uniforms: {
                uTension: { value: params.tension },
                uSize: { value: params.size },
                uColor: { value: new THREE.Color(params.color) }
            },
            vertexShader: `
                uniform float uTension;
                uniform float uSize;
                void main() {
                    vec3 pos = position * uTension;
                    vec4 mvPos = modelViewMatrix * vec4(pos, 1.0);
                    gl_PointSize = uSize * (1200.0 / -mvPos.z);
                    gl_Position = projectionMatrix * mvPos;
                }
            `,
            fragmentShader: `
                uniform vec3 uColor;
                void main() {
                    float d = distance(gl_PointCoord, vec2(0.5));
                    if (d > 0.5) discard;
                    float glow = pow(0.06 / d, 1.5);
                    gl_FragColor = vec4(uColor, glow);
                }
            `,
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
        updateTemplate();
    }

    function updateTemplate() {
        const attr = geometry.attributes.position;
        const count = params.count;
        
        for(let i=0; i<count; i++) {
            if(params.template === 'MilkyWay') {
                // Milky Way: Barred Spiral Structure
                const radius = Math.random() * 8;
                const spin = 1.3;
                const isBar = Math.random() > 0.75;
                
                if (isBar && radius < 2.2) {
                    // Central Bar Structure
                    attr.setXYZ(i, (Math.random()-0.5)*4.5, (Math.random()-0.5)*0.8, (Math.random()-0.5)*0.6);
                } else {
                    // Spiral Arms (Logarithmic)
                    const angle = radius * spin + (i % 2 === 0 ? 0 : Math.PI);
                    const drift = (Math.random() - 0.5) * 0.7;
                    attr.setXYZ(i, 
                        Math.cos(angle) * radius + drift, 
                        (Math.random()-0.5) * 0.3 * (9 - radius), 
                        Math.sin(angle) * radius + drift
                    );
                }
            } else if(params.template === 'Saturn') {
                if (i < count * 0.5) {
                    const phi = Math.acos(-1 + (2 * i) / (count * 0.5));
                    const theta = Math.sqrt(count * 0.5 * Math.PI) * phi;
                    attr.setXYZ(i, Math.cos(theta) * Math.sin(phi) * 1.5, Math.sin(theta) * Math.sin(phi) * 1.5, Math.cos(phi) * 1.5);
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 2.5 + Math.random() * 1.5;
                    attr.setXYZ(i, Math.cos(angle) * radius, (Math.random() - 0.5) * 0.1, Math.sin(angle) * radius);
                }
            } else if (params.template === 'Hearts') {
                const t = Math.random() * Math.PI * 2;
                attr.setXYZ(i, 1.6*Math.pow(Math.sin(t),3), (1.3*Math.cos(t)-0.5*Math.cos(2*t)-0.2*Math.cos(3*t)), (Math.random()-0.5)*0.5);
            } else { // Regular Galaxy
                const r = Math.random() * 5;
                const a = Math.random() * Math.PI * 2;
                attr.setXYZ(i, Math.cos(a)*r, (Math.random()-0.5)*5, Math.sin(a)*r);
            }
        }
        attr.needsUpdate = true;
    }

    async function setupAI() {
        const vision = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3");
        const fileset = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        handLandmarker = await vision.HandLandmarker.createFromOptions(fileset, {
            baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
            runningMode: "VIDEO", numHands: 1
        });
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = stream;
        return new Promise(res => video.onloadedmetadata = () => {
            video.play();
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;
            res();
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (handLandmarker && video.readyState === 4) {
            const res = handLandmarker.detectForVideo(video, performance.now());
            
            if (res.landmarks && res.landmarks.length > 0) {
                const hand = res.landmarks[0];
                window.drawConnectors(canvasCtx, hand, window.HAND_CONNECTIONS, {color: '#00ffcc', lineWidth: 2});
                window.drawLandmarks(canvasCtx, hand, {color: '#ffffff', lineWidth: 1, radius: 2});

                const wrist = hand[0];
                const pinchDist = Math.hypot(hand[4].x - hand[8].x, hand[4].y - hand[8].y);

                const targetTension = pinchDist * 7.5;
                params.tension = THREE.MathUtils.lerp(params.tension, targetTension, params.regainSpeed);

                const targetRotX = (wrist.y - 0.5) * Math.PI * 2;
                const targetRotY = (wrist.x - 0.5) * Math.PI * 2;
                particles.rotation.x = THREE.MathUtils.lerp(particles.rotation.x, targetRotX, params.rotationSmoothing);
                particles.rotation.y = THREE.MathUtils.lerp(particles.rotation.y, targetRotY, params.rotationSmoothing);

                status.innerText = "COSMIC LINK ACTIVE";
                subStatus.innerText = "CONTROLLING STELLAR FIELD";
            } else {
                params.tension = THREE.MathUtils.lerp(params.tension, params.scatterAmount, 0.03);
                particles.rotation.y += 0.005; 
                status.innerText = "COSMIC VOID";
                subStatus.innerText = "PARTICLES SCATTERED - SEEKING HAND";
            }
        }

        material.uniforms.uTension.value = params.tension;
        material.uniforms.uColor.value.set(params.color);
        material.uniforms.uSize.value = params.size;
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>